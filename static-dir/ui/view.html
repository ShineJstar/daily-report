<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DailyReport</title>
    <style type="text/css">
    body{
        font-size: 12px;
    }
    div.coll_item,div.copy_right_container{
        clear:both;
    }
    div.item{
        float: left;
    }
    div.title0{
        font-size: 14px;
        font-weight: bold;
        padding: 3;
        background-color: #36E636;
    }
    div.copy_right_container{
        padding-top: 5px;
    }
    div.copy_right{
        border-top: 1px solid #cccccc;
        font-size: 14px;
        font-weight: bold;
        padding: 3;
        background-color: #FFF;
        text-align: center;
    }
    div.title1{
        font-size: 14px;
        font-weight: bold;
        padding: 3;
        color: #fff;
        background-color: #3636FF;
    }
    div.cnt_left{
        float: left;
        background-color: #F6F6F6;
    }
    div.cnt_right{
        float: left;
        background-color: #E6E6E6;
    }
    div.item_title{
        font-size: 13px;
        font-weight: bold;
        padding: 3;
    }
    div.summary_product{
        float: left;
    }
    div.summary_product_text{
        float: left;
        font-size: 14px;
    }
    div.user_title{
        font-size: 14px;
        font-weight: bold;
        padding: 5;
        background-color: #3636FF;
        text-align: center;
        color: #fff;
    }
    div.user_text{
        background-color: #E6E6E6;
    }
    div.user_text_content, div.day_detail_summary_content{
        padding: 3;
        font-size: 12px;
        overflow: auto;
    }
    div.user_text_para{
        font-size: 12px;
    }
    
    div.coll_item{
        width: 1500px;
    }
    div.copy_right{
        margin-left: 150px;
        width: 1200px;
    }
    div.item{
        width: 750px;
    }
    div.cnt_left,div.cnt_right{
        width: 375px;
        height: 250px;
    }
    div.user_text{
        width: 750px;
        height: 250px;
    }
    div.user_text_content{
        width: 745px;
        height: 245px;
    }
    div.day_detail_summary{
        width: 750px;
    }
    </style>
</head>
<body id="body">
    <div>
        <div id="log" class="log"></div>
        <div>
            分组：<select id="group"><option value="">所有人</option></select>
            查询日期：<input id="write_time" type="text" size="10"/>
            <input id="view" value="查询" type="button"/>
            <input id="submit" value="写日报" type="button"/>
            <input id="yestoday" value="查询昨天" type="button"/>
            <input id="today" value="查询今天" type="button"/>
        </div>
    </div>
    <div id="report" style="display:none">
        <div class="coll_item">
            <div class="item" id="year_summary">
                <div class="title0">年度汇总</div>
                <div>
                    <div class="cnt_left">
                        <div class="item_title"><span id="product_label">产品</span>汇总</div>
                        <div>
                            <div id="year_product" class="summary_product"></div>
                            <div id="year_product_text" class="summary_product_text"></div>
                        </div>
                    </div>
                    <div class="cnt_right">
                        <div class="item_title"><span id="type_label">类型</span>汇总</div>
                        <div>
                            <div id="year_type" class="summary_product"></div>
                            <div id="year_type_text" class="summary_product_text"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="item" id="quarter_summary">
                <div class="title1">季度汇总</div>
                <div>
                    <div class="cnt_left">
                        <div class="item_title"><span id="product_label">产品</span>汇总</div>
                        <div>
                            <div id="quarter_product" class="summary_product"></div>
                            <div id="quarter_product_text" class="summary_product_text"></div>
                        </div>
                    </div>
                    <div class="cnt_right">
                        <div class="item_title"><span id="type_label">类型</span>汇总</div>
                        <div>
                            <div id="quarter_type" class="summary_product"></div>
                            <div id="quarter_type_text" class="summary_product_text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="coll_item">
            <div class="item" id="month_summary">
                <div class="title0">月度汇总</div>
                <div>
                    <div class="cnt_left">
                        <div class="item_title"><span id="product_label">产品</span>汇总</div>
                        <div>
                            <div id="month_product" class="summary_product"></div>
                            <div id="month_product_text" class="summary_product_text"></div>
                        </div>
                    </div>
                    <div class="cnt_right">
                        <div class="item_title"><span id="type_label">类型</span>汇总</div>
                        <div>
                            <div id="month_type" class="summary_product"></div>
                            <div id="month_type_text" class="summary_product_text"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="item" id="day_summary">
                <div class="title1" id="day_summary_title">当天汇总</div>
                <div>
                    <div class="cnt_left">
                        <div class="item_title"><span id="product_label">产品</span>汇总</div>
                        <div>
                            <div id="day_product" class="summary_product"></div>
                            <div id="day_product_text" class="summary_product_text"></div>
                        </div>
                    </div>
                    <div class="cnt_right">
                        <div class="item_title"><span id="type_label">类型</span>汇总</div>
                        <div>
                            <div id="day_type" class="summary_product"></div>
                            <div id="day_type_text" class="summary_product_text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="coll_item">
            <div class="title0" id="day_detail">当天详细</div>
            <div class="day_detail_summary">
                <div id="day_detail_summary" class="day_detail_summary_content"></div>
            </div>
            <div id="day_detail_items">
            </div>
        </div>
        <div class="copy_right_container">
            <div class="copy_right">
            CopyRight&copy;OpenSourceDailyReport, 2013.
            </div>
        </div>
    </div>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery.cookie.js"></script>
    <script type="text/javascript" src="raphael.js"></script>
    <script type="text/javascript" src="conf.js"></script>
    <script type="text/javascript">
        // http://raphaeljs.com/pie.html
        // http://raphaeljs.com/pie.js
        Raphael.fn.pieChart = function (hsb_start, cx, cy, r, values, labels, stroke) {
            var stroke_width = 2;
            var text_position_delta = -50;
            var font_text_size = 12;
            
            var paper = this,
                rad = Math.PI / 180,
                chart = this.set();
            function sector(cx, cy, r, startAngle, endAngle, params) {
                var x1 = cx + r * Math.cos(-startAngle * rad),
                    x2 = cx + r * Math.cos(-endAngle * rad),
                    y1 = cy + r * Math.sin(-startAngle * rad),
                    y2 = cy + r * Math.sin(-endAngle * rad);
                return paper.path(["M", cx, cy, "L", x1, y1, "A", r, r, 0, +(endAngle - startAngle > 180), 0, x2, y2, "z"]).attr(params);
            }
            
            // draw bg fill when only 1 element
            if(values.length == 1){
                var circle = paper.circle(cx, cy, r);
                color = Raphael.hsb(hsb_start, .75, 1),
                circle.attr("fill", color);
                circle.attr("stroke", stroke);
                circle.attr("stroke-width", stroke_width);
                
                var label = labels[0] + '\n' + values[0] + '%';
                circle.attr("title", label);
            }
            
            // draw pie.
            var angle = 0,
                total = 0,
                start = hsb_start,
                process = function (j) {
                    var value = values[j],
                        angleplus = 360 * value / total,
                        popangle = angle + (angleplus / 2),
                        color = Raphael.hsb(start, .75, 1),
                        ms = 500,
                        delta = text_position_delta,
                        bcolor = Raphael.hsb(start, 1, 1),
                        label = labels[j] + '\n' + value + '%',
                        p = sector(cx, cy, r, angle, angle + angleplus, {fill: "90-" + bcolor + "-" + color, stroke: stroke, "stroke-width": stroke_width, "title": label}),
                        label_color = Raphael.hsb(start, 1, 0.5),
                        txt_cx = cx + (r + delta) * Math.cos(-popangle * rad),
                        txt_cy = cy + (r + delta) * Math.sin(-popangle * rad),
                        txt = paper.text(txt_cx, txt_cy, label).attr({fill: label_color, stroke: "none", opacity: 1, "font-size": font_text_size, "title": label});
                    p.mouseover(function () {
                        p.stop().animate({transform: "s1.1 1.1 " + cx + " " + cy}, ms, "elastic");
                        txt.stop().animate({opacity: 1}, ms, "elastic");
                    }).mouseout(function () {
                        p.stop().animate({transform: ""}, ms, "elastic");
                        txt.stop().animate({opacity: 1}, ms);
                    });
                    angle += angleplus;
                    chart.push(p);
                    chart.push(txt);
                    start += .1;
                };
            for (var i = 0, ii = values.length; i < ii; i++) {
                total += values[i];
            }
            for (i = 0; i < ii; i++) {
                process(i);
            }
            return chart;
        };
    </script>
    <script type="text/javascript">
        function error(msg){
            $("#log").html('<font color="red">' + msg + '</font>');
        }
        function trace(msg){
            $("#log").html('<font color="#33AA33">' + msg + '</font>');
            //console.log(msg);
        }
        // @date_in_string ie. 2013-8-13
        // @return Date object.
        function parseToDate(date_in_string){
            var date = new Date();
            date.setTime(Date.parse(date_in_string));
            return date;
        }
        function parseDate(date){
            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
        }
        function parseYestodayDate(date){
            date.setDate(date.getDate() - 1);
            var str = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
            date.setDate(date.getDate() + 1);
            
            return str;
        }
        function parse_query_string(){
            var query_string = String(window.location.search).split("?")[1];
            if(query_string == undefined){
                return {};
            }
            
            var queries = query_string.split("&");
            var obj = {};
            $(queries).each(function(){
                var query = this.split("=");
                obj[query[0]] = query[1];
            });
            
            return obj;
        }
        var ajax_alert_window = true;
        function ajax_error_callback(event, jqxhr){
            //console.log(jqxhr);
            error("ajax请求错误, status=" + jqxhr.status);
            
            if(jqxhr.status == 401){
                error("该页面需要登录后才能查看，请您先登录");
                
                if(ajax_alert_window){
                    alert("该页面需要登录后才能查看，请您先登录");
                    ajax_alert_window = false;
                }
                
                window.location.href = "auth.html";
                return;
            }
            
            if(jqxhr.status == 403){
                error("权限限制：您请求了未授权的资源");
                
                if(ajax_alert_window){
                    alert("权限限制：您请求了未授权的资源");
                    ajax_alert_window = false;
                }
                return;
            }
            
            error("程序错误, code="+jqxhr.status);
            if(ajax_alert_window){
                alert("程序错误, code="+jqxhr.status);
                ajax_alert_window = false;
            }
        }
        function is_crossdomain(){
            var o = window.location;
            
            var service_name = "api";
            var this_domain_api = o.protocol + '//' + o.hostname + ':' + o.port + '/' + service_name;
            
            if(this_domain_api != get_service_url(service_name)){
                return true;
            }
            return false;
        }
        function generate_api_key(url){
            if(!is_crossdomain()){
                return url;
            }
            
            var api_key = $.cookie("api_key");
            
            if(!api_key){
                return url;
            }
            
            if(url.indexOf("?") == -1){
                return url + "?" + "api_key=" + api_key;
            }
            return url + "&" + "api_key=" + api_key;
        }
        var browser={
            agents:function(){
                var agent = navigator.userAgent;
                return {
                    // platform
                    Android: agent.indexOf("Android") != -1,
                    Windows: agent.indexOf("Windows") != -1,
                    iPhone: agent.indexOf("iPhone") != -1,
                    // Windows Browsers
                    Chrome: agent.indexOf("Chrome") != -1,
                    Firefox: agent.indexOf("Firefox") != -1,
                    QQBrowser: agent.indexOf("QQBrowser") != -1,
                    MSIE: agent.indexOf("MSIE") != -1, 
                    // Android Browsers
                    Opera: agent.indexOf("Presto") != -1,
                    MQQBrowser: agent.indexOf("MQQBrowser") != -1,
                };
            }()
        };
        // when browser warning, for example maybe not compatible, show warn message in the timeout.
        var browser_warning_timeout_seconds = 3;
        
        // main function
        $(function(){
            document.title = get_system_title();
            $("#body").hide();
            
            initialize_page();
            
            $("div").ajaxError(ajax_error_callback);
            
            $("#view").click(function(){
                show_report();
            });
            
            $("#submit").click(function(){
                window.location.href = "submit.html";
            });
            
            $("#yestoday").click(function(){
                $("#write_time").val(parseYestodayDate(new Date()));
                trace("正在查询日报");
                show_report();
            });
            
            $("#today").click(function(){
                $("#write_time").val(parseDate(new Date()));
                trace("正在查询日报");
                show_report();
            });
            
            $.getJSON(get_service_url(generate_api_key("/groups")), function(data){
                $("#body").show();
                
                for(var i = 0; i < data.length; i++){
                    var group = data[i];
                    
                    var option = document.createElement("option");
                    $(option).val(group.id);
                    $(option).text(group.value);
                    
                    $("#group").append(option);
                }
                
                $("#write_time").val(parseDate(new Date()));
                if(!browser.agents.Windows || !browser.agents.Chrome){
                    trace("请查询数据");
                    error("您的浏览器不是Windows下的Chrome，统计报表图可能会出现问题");
                    setTimeout(do_url_query, browser_warning_timeout_seconds * 1000);
                }
                else{
                    do_url_query();
                }
            });
        });
        
        function on_start_query(){
            $("#view").attr("disabled", true);
            $("#yestoday").attr("disabled", true);
            $("#today").attr("disabled", true);
        }
        function on_stop_query(){
            $("#view").attr("disabled", false);
            $("#yestoday").attr("disabled", false);
            $("#today").attr("disabled", false);
        }
        
        function do_url_query(){
            var obj = parse_query_string();
            
            if(obj.date != undefined){
                $("#write_time").val(obj.date);
            }
            
            if(obj.auto_query == 1){
                show_report();
                return;
            }
        }
        
        function initialize_page(){
            $("#year_summary").find("#product_label").text(get_product_label());
            $("#year_summary").find("#type_label").text(get_type_label());
            $("#quarter_summary").find("#product_label").text(get_product_label());
            $("#quarter_summary").find("#type_label").text(get_type_label());
            $("#month_summary").find("#product_label").text(get_product_label());
            $("#month_summary").find("#type_label").text(get_type_label());
            $("#day_summary").find("#product_label").text(get_product_label());
            $("#day_summary").find("#type_label").text(get_type_label());
        }
        
        function show_report(){
            on_start_query();
            
            $("#report").show();
            
            // convert date string to date object.
            // for example, "2013-8-18" to "Sun Aug 18 2013 00:00:00 GMT+0800 (中国标准时间)"
            var date = parseToDate($("#write_time").val());
            //trace(date.toString());
            
            // query the report data.
            query_report_basic(date);
        }
        
        var data = {};
        function query_report_basic(date){
            data = {};
            
            // save the query date.
            data.date = date;
            // the reports data.
            data.reports = {};
            // the group id
            data.group = $("#group").val();
            
            // query basic info, users/products/work_types.
            trace("请求users数据");
            $.getJSON(get_service_url(generate_api_key("/users?group=" + data.group)), function(ret){
                $("#body").show();
                
                data.users = ret.users;
                data.users_kv = {};
                for(var i = 0; i < ret.users.length; i++){
                    data.users_kv[ret.users[i].id] = ret.users[i].value;
                }
                
                trace("请求products数据");
                $.getJSON(get_service_url(generate_api_key("/products")), function(products){
                    data.products = products;
                    data.products_kv = {};
                    for(var i = 0; i < products.length; i++){
                        data.products_kv[products[i].id] = products[i].value;
                    }
                    
                    trace("请求work_types数据");
                    $.getJSON(get_service_url(generate_api_key("/work_types")), function(work_types){
                        data.work_types = work_types;
                        data.work_types_kv = {};
                        for(var i = 0; i < work_types.length; i++){
                            data.work_types_kv[work_types[i].id] = work_types[i].value;
                        }
                        
                        setTimeout(query_report_user_detail, 0);
                    });
                });
            });
        }
        function query_report_user_detail(){
            if(data.users.length == 0){
                error("选择的组没有用户");
                $("#year_product").empty();
                $("#year_product_text").empty();
                $("#year_type").empty();
                $("#year_type_text").empty();
                $("#quarter_product").empty();
                $("#quarter_product_text").empty();
                $("#quarter_type").empty();
                $("#quarter_type_text").empty();
                $("#month_product").empty();
                $("#month_product_text").empty();
                $("#month_type").empty();
                $("#month_type_text").empty();
                $("#day_product").empty();
                $("#day_product_text").empty();
                $("#day_type").empty();
                $("#day_type_text").empty();
                $("#day_detail_items").empty();
                
                on_stop_query();
                return;
            }
            
            trace("请求日期" + parseDate(data.date) + "的日报数据");
            
            data.reports.user_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.users.length; i++){
                var url = "/reports?summary=0"+"&group="+data.group+"&start_time=" + parseDate(data.date) + "&end_time=" + parseDate(data.date) + "&user_id=" + data.users[i].id;
                trace("请求用户" + data.users[i].value + "在" + parseDate(data.date) + "的数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(user_data){
                    if(user_data.length > 0){
                        data.reports.user_data.push(user_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.users.length){
                        setTimeout(query_report_day_product_summary, 0);
                    }
                });
            }
        }
        function query_report_day_product_summary(){
            trace("请求当天日报product汇总数据");
            
            var start_time = parseDate(data.date);
            var end_time = parseDate(data.date);
            
            trace("请求当天日报product汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.day_product_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.products.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&product_id=" + data.products[i].id;
                trace("请求产品'" + data.products[i].value + "'的当天汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.day_product_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.products.length){
                        setTimeout(query_report_day_type_summary, 0);
                    }
                });
            }
        }
        function query_report_day_type_summary(){
            trace("请求当天日报type汇总数据");
            
            var start_time = parseDate(data.date);
            var end_time = parseDate(data.date);
            
            trace("请求当天日报type汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.day_type_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.work_types.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&type_id=" + data.work_types[i].id;
                trace("请求工作类型'" + data.work_types[i].value + "'的当天汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.day_type_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.work_types.length){
                        setTimeout(query_report_month_product_summary, 0);
                    }
                });
            }
        }
        function query_report_month_product_summary(){
            trace("请求月度日报product汇总数据");
            
            var date_copy = new Date();
            date_copy.setTime(data.date.getTime());
            
            date_copy.setDate(1);
            var start_time = parseDate(date_copy);
            
            date_copy.setMonth(date_copy.getMonth() + 1);
            date_copy.setDate(date_copy.getDate() - 1);
            var end_time = parseDate(date_copy);
            
            trace("请求月度日报product汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.month_product_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.products.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&product_id=" + data.products[i].id;
                trace("请求产品'" + data.products[i].value + "'的月度汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.month_product_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.products.length){
                        setTimeout(query_report_month_type_summary, 0);
                    }
                });
            }
        }
        function query_report_month_type_summary(){
            trace("请求月度日报type汇总数据");
            
            var date_copy = new Date();
            date_copy.setTime(data.date.getTime());
            
            date_copy.setDate(1);
            var start_time = parseDate(date_copy);
            
            date_copy.setMonth(date_copy.getMonth() + 1);
            date_copy.setDate(date_copy.getDate() - 1);
            var end_time = parseDate(date_copy);
            
            trace("请求月度日报type汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.month_type_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.work_types.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&type_id=" + data.work_types[i].id;
                trace("请求工作类型'" + data.work_types[i].value + "'的月度汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.month_type_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.work_types.length){
                        setTimeout(query_report_quarter_product_summary, 0);
                    }
                });
            }
        }
        function query_report_quarter_product_summary(){
            trace("请求季度日报product汇总数据");
            
            var date_copy = new Date();
            date_copy.setTime(data.date.getTime());
            
            date_copy.setDate(1);
            date_copy.setMonth(parseInt(date_copy.getMonth() / 3) * 3);
            var start_time = parseDate(date_copy);
            
            date_copy.setMonth(parseInt(date_copy.getMonth() / 3 + 1) * 3);
            date_copy.setDate(date_copy.getDate() - 1);
            var end_time = parseDate(date_copy);
            
            trace("请求季度日报product汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.quarter_product_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.products.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&product_id=" + data.products[i].id;
                trace("请求产品'" + data.products[i].value + "'的季度汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.quarter_product_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.products.length){
                        setTimeout(query_report_quarter_type_summary, 0);
                    }
                });
            }
        }
        function query_report_quarter_type_summary(){
            trace("请求季度日报type汇总数据");
            
            var date_copy = new Date();
            date_copy.setTime(data.date.getTime());
            
            date_copy.setDate(1);
            date_copy.setMonth(parseInt(date_copy.getMonth() / 3) * 3);
            var start_time = parseDate(date_copy);
            
            date_copy.setMonth(parseInt(date_copy.getMonth() / 3 + 1) * 3);
            date_copy.setDate(date_copy.getDate() - 1);
            var end_time = parseDate(date_copy);
            
            trace("请求季度日报type汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.quarter_type_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.work_types.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&type_id=" + data.work_types[i].id;
                trace("请求工作类型'" + data.work_types[i].value + "'的季度汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.quarter_type_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.work_types.length){
                        setTimeout(query_report_year_product_summary, 0);
                    }
                });
            }
        }
        function query_report_year_product_summary(){
            trace("请求年度日报product汇总数据");
            
            var date_copy = new Date();
            date_copy.setTime(data.date.getTime());
            
            date_copy.setMonth(0);
            date_copy.setDate(1);
            var start_time = parseDate(date_copy);
            
            date_copy.setFullYear(date_copy.getFullYear() + 1);
            date_copy.setDate(date_copy.getDate() - 1);
            var end_time = parseDate(date_copy);
            
            trace("请求年度日报product汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.year_product_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.products.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&product_id=" + data.products[i].id;
                trace("请求产品'" + data.products[i].value + "'的年度汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.year_product_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.products.length){
                        setTimeout(query_report_year_type_summary, 0);
                    }
                });
            }
        }
        function query_report_year_type_summary(){
            trace("请求年度日报type汇总数据");
            
            var date_copy = new Date();
            date_copy.setTime(data.date.getTime());
            
            date_copy.setMonth(0);
            date_copy.setDate(1);
            var start_time = parseDate(date_copy);
            
            date_copy.setFullYear(date_copy.getFullYear() + 1);
            date_copy.setDate(date_copy.getDate() - 1);
            var end_time = parseDate(date_copy);
            
            trace("请求年度日报type汇总数据" + "，" + start_time + "至" + end_time);
            
            data.reports.year_type_data = [];
            var responsed_count = 0;
            for(var i = 0; i < data.work_types.length; i++){
                var url = "/reports?summary=1"+"&group="+data.group+"&start_time=" + start_time + "&end_time=" + end_time + "&type_id=" + data.work_types[i].id;
                trace("请求工作类型'" + data.work_types[i].value + "'的年度汇总数据");
                $.getJSON(get_service_url(generate_api_key(url)), function(response_data){
                    if(response_data.work_hours != null){
                        data.reports.year_type_data.push(response_data);
                    }
                    // if all data requested, request other messages.
                    if(++responsed_count == data.work_types.length){
                        trace("数据查询完毕，展示日报");
                        setTimeout(render_report, 0);
                    }
                });
            }
        }
        
        // sort: big to small, desc
        function work_hours_sort(a, b){
            return b.work_hours - a.work_hours;
        }
        // sort: user id big to small, desc
        function user_id_sort(a, b){
            if(a.length > 0 && b.length > 0){
                return b[0].user_id - a[0].user_id;
            }
            return 0;
        }
        // sort: user report id small to big, asc.
        function report_sort(a, b){
            return a.report_id - b.report_id;
        }
        // sort: user report insert_date small to big, asc.
        function report_first_insert_sort(a, b){
            return parseToDate(a.insert_date).getTime() - parseToDate(b.insert_date).getTime();
        }
        // sort: user report modify_date small to big, asc.
        function report_modify_date_sort(a, b){
            return parseToDate(b.modify_date).getTime() - parseToDate(a.modify_date).getTime();
        }
        
        function render_year_product(){
            $("#year_product").empty();
            $("#year_product_text").empty();
            data.reports.year_product_data.sort(work_hours_sort);
            if(data.reports.year_product_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.year_product_data.length; i++){
                    labels.push(data.products_kv[data.reports.year_product_data[i].product_id]);
                    total_value += data.reports.year_product_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.year_product_data.length; i++){
                    var percent = data.reports.year_product_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("year_product", 220, 220).pieChart(0.1/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#year_product_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#year_product_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#year_product").text("没有数据");
            }
        }
        function render_year_type(){
            $("#year_type").empty();
            $("#year_type_text").empty();
            data.reports.year_type_data.sort(work_hours_sort);
            if(data.reports.year_type_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.year_type_data.length; i++){
                    labels.push(data.work_types_kv[data.reports.year_type_data[i].type_id]);
                    total_value += data.reports.year_type_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.year_type_data.length; i++){
                    var percent = data.reports.year_type_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("year_type", 220, 220).pieChart(0.15/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#year_type_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#year_type_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#year_type").text("没有数据");
            }
        }
        function render_quarter_product(){
            $("#quarter_product").empty();
            $("#quarter_product_text").empty();
            data.reports.quarter_product_data.sort(work_hours_sort);
            if(data.reports.quarter_product_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.quarter_product_data.length; i++){
                    labels.push(data.products_kv[data.reports.quarter_product_data[i].product_id]);
                    total_value += data.reports.quarter_product_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.quarter_product_data.length; i++){
                    var percent = data.reports.quarter_product_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("quarter_product", 220, 220).pieChart(0.2/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#quarter_product_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#quarter_product_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#quarter_product").text("没有数据");
            }
        }
        function render_quarter_type(){
            $("#quarter_type").empty();
            $("#quarter_type_text").empty();
            data.reports.quarter_type_data.sort(work_hours_sort);
            if(data.reports.quarter_type_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.quarter_type_data.length; i++){
                    labels.push(data.work_types_kv[data.reports.quarter_type_data[i].type_id]);
                    total_value += data.reports.quarter_type_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.quarter_type_data.length; i++){
                    var percent = data.reports.quarter_type_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("quarter_type", 220, 220).pieChart(0.25/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#quarter_type_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#quarter_type_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#quarter_type").text("没有数据");
            }
        }
        function render_month_product(){
            $("#month_product").empty();
            $("#month_product_text").empty();
            data.reports.month_product_data.sort(work_hours_sort);
            if(data.reports.month_product_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.month_product_data.length; i++){
                    labels.push(data.products_kv[data.reports.month_product_data[i].product_id]);
                    total_value += data.reports.month_product_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.month_product_data.length; i++){
                    var percent = data.reports.month_product_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("month_product", 220, 220).pieChart(0.3/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#month_product_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#month_product_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#month_product").text("没有数据");
            }
        }
        function render_month_type(){
            $("#month_type").empty();
            $("#month_type_text").empty();
            data.reports.month_type_data.sort(work_hours_sort);
            if(data.reports.month_type_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.month_type_data.length; i++){
                    labels.push(data.work_types_kv[data.reports.month_type_data[i].type_id]);
                    total_value += data.reports.month_type_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.month_type_data.length; i++){
                    var percent = data.reports.month_type_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("month_type", 220, 220).pieChart(0.35/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#month_type_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#month_type_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#month_type").text("没有数据");
            }
        }
        function render_day_product(){
            $("#day_product").empty();
            $("#day_product_text").empty();
            data.reports.day_product_data.sort(work_hours_sort);
            if(data.reports.day_product_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.day_product_data.length; i++){
                    labels.push(data.products_kv[data.reports.day_product_data[i].product_id]);
                    total_value += data.reports.day_product_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.day_product_data.length; i++){
                    var percent = data.reports.day_product_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("day_product", 220, 220).pieChart(0.4/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#day_product_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#day_product_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#day_product").text("没有数据");
            }
        }
        function render_day_type(){
            $("#day_type").empty();
            $("#day_type_text").empty();
            data.reports.day_type_data.sort(work_hours_sort);
            if(data.reports.day_type_data.length > 0){
                var values = [];
                var labels = [];
                var total_value = 0;
                for(var i = 0; i < data.reports.day_type_data.length; i++){
                    labels.push(data.work_types_kv[data.reports.day_type_data[i].type_id]);
                    total_value += data.reports.day_type_data[i].work_hours;
                }
                for(var i = 0; i < data.reports.day_type_data.length; i++){
                    var percent = data.reports.day_type_data[i].work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("day_type", 220, 220).pieChart(0.45/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#day_type_text").append(labels[i] + ": " + values[i] + "%<br/>");
                }
                if(enable_view_sum()){
                    $("#day_type_text").append(get_view_sum_label() + Number(total_value).toFixed(1) + get_view_sum_unit_label() + "<br/>");
                }
            }
            else{
                $("#day_type").text("没有数据");
            }
        }
        function get_day_detail_users_sum(){
            var day_detail_users_sum = "";
            
            if(data.reports.user_data.length > 0){
                day_detail_users_sum = "(共" + data.reports.user_data.length + "/" + data.users.length + "人)";
            }
            
            return day_detail_users_sum;
        }
        function get_delayied_report_summary(users_submited_ids){
            var delayed_reports = "";
            
            //console.log(data);
            for(var i = 0; i < users_submited_ids.length; i++){
                var user_id = users_submited_ids[i];
                
                for(var j = 0; j < data.reports.user_data.length; j++){
                    var user_data = data.reports.user_data[j];
                    
                    if(user_id != user_data[0].user_id){
                        continue;
                    }
                    
                    var work_date = user_data[0].work_date;
                    
                    user_data.sort(report_first_insert_sort);
                    var first_insert = user_data[0].insert_date;
                    
                    user_data.sort(report_modify_date_sort);
                    var last_modify = user_data[0].modify_date;
                    
                    // detect the delayed reports
                    if(!is_report_delayed(parseToDate(work_date), parseToDate(first_insert))){
                        continue;
                    }
                    
                    delayed_reports += data.users_kv[user_id] + " 提交时间:" + first_insert + " 最后更新:" + last_modify + "<br/>";
                }
            }
            
            if(delayed_reports != ""){
                delayed_reports = "延迟提交日报名单" + "<br/>" + delayed_reports;
            }
            
            return delayed_reports;
        }
        function build_users_specified_by_submited(users_submited, users_submited_ids, users_not_submited){
            for(var i = 0; i < data.users.length; i++){
                var user = data.users[i];
                var user_reported = false;
                
                for(var j = 0; j < data.reports.user_data.length; j++){
                    if(user.id == data.reports.user_data[j][0].user_id){
                        users_submited.push(user.value);
                        users_submited_ids.push(user.id);
                        user_reported = true;
                    }
                }
                
                if(!user_reported){
                    users_not_submited.push(user.value);
                }
            }
        }
        function render_day_detail_summary(){
            // generate the users array specified by submited or not submited.
            var users_submited = [], users_submited_ids = [], users_not_submited = [];
            build_users_specified_by_submited(users_submited, users_submited_ids, users_not_submited);
            
            var day_detail_summary = '' +
                '总人数：' + data.users.length + '<br/>' +
                '已填写日报人数：' + data.reports.user_data.length + "人 " + users_submited.join(",") + '<br/>' + 
                '未填写日报人数：' + (data.users.length - data.reports.user_data.length) + "人 " + users_not_submited.join(",") + '<br/>' +
                get_delayied_report_summary(users_submited_ids)+
                '';
                
            $("#day_detail_summary").html(day_detail_summary);
        }
        function render_day_detail(){
            // summaries of day detail.
            render_day_detail_summary();
            
            // render each user.
            $("#day_detail_items").empty();
            data.reports.user_data.sort(user_id_sort);
            if(data.reports.user_data.length > 0){
                for(var i = 0; i < data.reports.user_data.length; i++){
                    var user_data = data.reports.user_data[i];
                    
                    if(user_data.length <= 0){
                        continue;
                    }
                    
                    render_user(user_data);
                }
            }
            else{
                $("#day_detail_items").text("没有数据");
            }
        }
        function render_user(user_data){
            var user_id = user_data[0].user_id;
            
            var template_user_html = 
                '<div>'+
                '    <div class="user_title" id="user_title">XXX日报</div>'+
                '</div>'+
                '<div class="item">'+
                '    <div class="user_text"><div id="user_text" class="user_text_content"></div></div>'+
                '</div>'+
                '<div class="item">'+
                '    <div>'+
                '        <div class="cnt_left">'+
                '            <div class="item_title"><span id="product_label">产品</span>汇总</div>'+
                '            <div>'+
                '               <div id="user_product'+user_id+'" class="summary_product"></div>'+
                '               <div id="user_product_text'+user_id+'" class="summary_product_text"></div>'+
                '            </div>'+
                '        </div>'+
                '        <div class="cnt_right">'+
                '            <div class="item_title"><span id="type_label">类型</span>汇总</div>'+
                '            <div>'+
                '                <div id="user_type'+user_id+'" class="summary_product"></div>'+
                '                <div id="user_type_text'+user_id+'" class="summary_product_text"></div>'+
                '            </div>'+
                '        </div>'+
                '    </div>'+
                '</div>'+
                '';
                
            var div = document.createElement("div");
            $(div).html(template_user_html);
            $("#day_detail_items").append(div);
            
            $(div).find("#product_label").text(get_product_label());
            $(div).find("#type_label").text(get_type_label());
            
            var user_name = data.users_kv[user_id];
            var user_title_text = user_name + "-" + parseDate(data.date) + "-" + "日报";
            $(div).find("#user_title").text(user_title_text);
            
            $(div).find("#user_text").append(user_title_text);
            user_data.sort(report_sort);
            for(var i = 0; i < user_data.length; i++){
                var o = user_data[i];
                var redmine_url = "#";
                if(o.bug_id != 0){
                    redmine_url = get_redmine_issue_url() + "/" + o.bug_id;
                }
                var url = '<a href="' + redmine_url + '">refs#' + o.bug_id + ':</a>';
                var hour = o.work_hours + get_view_sum_unit_label();
                var text = '<p class="user_text_para">' + (i+1) + "." + url + " " + hour + ", " + o.report_content + "</p>";
                $(div).find("#user_text").append(text);
            }
            
            if(1){
                var total_value = 0;
                var products_merged = {};
                for(var i = 0; i < user_data.length; i++){
                    var o = user_data[i];
                    products_merged[data.products_kv[o.product_id]] = 0;
                }
                for(var i = 0; i < user_data.length; i++){
                    var o = user_data[i];
                    total_value += o.work_hours;
                    products_merged[data.products_kv[o.product_id]] += o.work_hours;
                }
                
                // dump to object array for sort
                var products_merged_object_array = [];
                for(var key in products_merged){
                    products_merged_object_array.push({name:key, work_hours:products_merged[key]});
                }
                products_merged_object_array.sort(work_hours_sort);
                
                // summaries
                user_data.sort(report_first_insert_sort);
                var first_insert = user_data[0].insert_date;
                user_data.sort(report_modify_date_sort);
                var last_modify = user_data[0].modify_date;
                var text = '<p class="user_text_para">' + '总计:' + Number(total_value).toFixed(1) + get_view_sum_unit_label() 
                    + ', 提交时间:' + first_insert + ', 最后更新:' + last_modify + '</p>';
                $(div).find("#user_text").append(text);
                
                var values = [];
                var labels = [];
                for(var i = 0; i < products_merged_object_array.length; i++){
                    var key = products_merged_object_array[i].name;
                    var work_hours = products_merged_object_array[i].work_hours;
                    
                    labels.push(key);
                    var percent = work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("user_product"+user_id, 220, 220).pieChart(0.5/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#user_product_text"+user_id).append(labels[i] + ": " + values[i] + "%<br/>");
                }
            }
            
            if(1){
                var total_value = 0;
                var types_merged = {};
                for(var i = 0; i < user_data.length; i++){
                    var o = user_data[i];
                    types_merged[data.work_types_kv[o.type_id]] = 0;
                }
                for(var i = 0; i < user_data.length; i++){
                    var o = user_data[i];
                    total_value += o.work_hours;
                    types_merged[data.work_types_kv[o.type_id]] += o.work_hours;
                }
                
                // dump to object array for sort
                var types_merged_object_array = [];
                for(var key in types_merged){
                    types_merged_object_array.push({name:key, work_hours:types_merged[key]});
                }
                types_merged_object_array.sort(work_hours_sort);
                
                var values = [];
                var labels = [];
                for(var i = 0; i < types_merged_object_array.length; i++){
                    var key = types_merged_object_array[i].name;
                    var work_hours = types_merged_object_array[i].work_hours;
                    
                    labels.push(key);
                    var percent = work_hours * 100 / total_value;
                    percent = Number(percent).toFixed(1);
                    values.push(percent);
                }
                Raphael("user_type"+user_id, 220, 220).pieChart(0.55/*hsb_start*/, 110, 110, 100, values, labels, "#fff");
                
                for(var i = 0; i < values.length; i++){
                    $("#user_type_text"+user_id).append(labels[i] + ": " + values[i] + "%<br/>");
                }
            }
        }
        function render_report(){
            //console.log(data);
            
            // year: product view.
            render_year_product();
            
            // year: product view.
            render_year_type();
            
            // quarter: product view.
            render_quarter_product();
            
            // quarter: product view.
            render_quarter_type();
            
            // month: product view.
            render_month_product();
            
            // month: product view.
            render_month_type();
            
            // day: product view.
            render_day_product();
            
            // day: product view.
            $("#day_summary_title").text(parseDate(data.date) + "汇总" + get_day_detail_users_sum());
            render_day_type();
            
            // day: detail view
            $("#day_detail").text(parseDate(data.date) + "详细" + get_day_detail_users_sum());
            render_day_detail();
            
            on_stop_query();
        }
    </script>
</body>
